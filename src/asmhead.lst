     1 00000000                                 ; os
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4  = 00280000                              botpak  equ     0x00280000  ;加载bootpack
     5  = 00100000                              dskcac  equ     0x00100000  ;磁盘缓存位置
     6  = 00008000                              dskcac0 equ     0x00008000  ;磁盘的缓存模式（实模式）    
     7 00000000                                 
     8 00000000                                 ;有关BOOT_INFO
     9  = 00000FF0                              cyls    equ     0x0ff0  ;设定启动区
    10  = 00000FF1                              leds    equ     0x0ff1
    11  = 00000FF2                              vmode   equ     0x0ff2  ;关于颜色数目的信息。颜色的位数
    12  = 00000FF4                              scrnx   equ     0x0ff4  ;分辨率的x
    13  = 00000FF6                              scrny   equ     0x0ff6  ;分辨率的y
    14  = 00000FF8                              vram    equ     0x0ff8  ;图像缓冲区的地址  
    15 00000000                                 
    16                                          ORG     0xc200
    17 0000C200                                 ;设置屏幕模式
    18 0000C200 B0 13                           mov     al, 0x13        ;VGA显卡，320*200*8位彩色
    19 0000C202 B4 00                           mov     ah, 0x00
    20 0000C204 CD 10                           int     0x10
    21 0000C206 C6 06 0FF2 08                   mov     byte [vmode], 8     ;记录画面模式
    22 0000C20B C7 06 0FF4 0140                 mov     word [scrnx], 320
    23 0000C211 C7 06 0FF6 00C8                 mov     word [scrny], 200
    24 0000C217 66 C7 06 0FF8 000A0000          mov     dword [vram], 0x000a0000
    25 0000C220                                 
    26 0000C220                                 ;用bios取得键盘上各种led灯的指示状态
    27 0000C220 B4 02                           mov     ah, 0x02
    28 0000C222 CD 16                           int     0x16        ;keyborad bios
    29 0000C224 A2 0FF1                         mov     [leds], al
    30 0000C227                                 
    31 0000C227                                 
    32 0000C227                                 ;防止pic接受所有中断
    33 0000C227                                 ;AT兼容机的规范、pic的初始化
    34 0000C227                                 ;然后之前再CLI不做任何事就挂起
    35 0000C227                                 ;pic再同意后初始化
    36 0000C227                                 
    37 0000C227 B0 FF                               mov al, 0xff
    38 0000C229 E6 21                               out 0x21, al
    39 0000C22B 90                                  nop             ;不断执行out指令
    40 0000C22C E6 A1                               out 0xa1, al
    41 0000C22E FA                                  cli
    42 0000C22F                                 ;让cpu支持1M以上的内存、设置A20GATE
    43 0000C22F E8 00B5                             call waitkbdout
    44 0000C232 B0 D1                               mov  al, 0xd1
    45 0000C234 E6 64                               out  0x64, al
    46 0000C236 E8 00AE                             call waitkbdout
    47 0000C239 B0 DF                               mov  al, 0xdf
    48 0000C23B E6 60                               out  0x60, al
    49 0000C23D E8 00A7                             call waitkbdout
    50 0000C240                                 
    51 0000C240                                 ;保护模式转换
    52 0000C240                                     [instrset "i486p"]  ;说明使用486指令
    53 0000C240 0F 01 16 C32A                       lgdt [gdtr0]        ;设置临时GDT
    54 0000C245 0F 20 C0                            mov  eax, cr0
    55 0000C248 66 25 7FFFFFFF                      and  eax, 0x7fffffff;使用bit31（禁用分页）
    56 0000C24E 66 83 C8 01                         or   eax, 0x00000001;bit0到1转换（保护模式过渡）
    57 0000C252 0F 22 C0                            mov  cr0, eax
    58 0000C255 EB 00                               jmp  pipelineflush
    59 0000C257                                 
    60 0000C257                                 pipelineflush:
    61 0000C257 B8 0008                             mov ax, 1*8         ;写32bit的段
    62 0000C25A 8E D8                               mov ds, ax
    63 0000C25C 8E C0                               mov es, ax
    64 0000C25E 8E E0                               mov fs, ax
    65 0000C260 8E E8                               mov gs, ax
    66 0000C262 8E D0                               mov ss, ax
    67 0000C264                                 ;bootpack 传递
    68 0000C264 66 BE 0000C330                      mov esi, bootpack   ;源
    69 0000C26A 66 BF 00280000                      mov edi, botpak     ;目标
    70 0000C270 66 B9 00020000                      mov ecx, 512*1024/4
    71 0000C276 E8 0075                             call memcpy
    72 0000C279                                 ;传输磁盘数据
    73 0000C279                                 ;从引导区开始
    74 0000C279 66 BE 00007C00                      mov esi, 0x7c00     ;源
    75 0000C27F 66 BF 00100000                      mov edi, dskcac     ;目标
    76 0000C285 66 B9 00000080                      mov ecx, 512/4
    77 0000C28B E8 0060                             call memcpy
    78 0000C28E                                 ;剩余的全部
    79 0000C28E 66 BE 00008200                      mov  esi, dskcac0+512    ;源
    80 0000C294 66 BF 00100200                      mov  edi, dskcac+512     ;目标
    81 0000C29A 66 B9 00000000                      mov  ecx, 0
    82 0000C2A0 8A 0E 0FF0                          mov  cl, byte [cyls]
    83 0000C2A4 66 69 C9 00001200                   imul ecx, 512*18*2/4    ;除以4得到字节数
    84 0000C2AB 66 81 E9 00000080                   sub  ecx, 512/4         ;ipl偏移量
    85 0000C2B2 E8 0039                             call memcpy
    86 0000C2B5                                 ;由于还需要asmhead才能完成
    87 0000C2B5                                 ;完成其余的bootpack任务
    88 0000C2B5                                 
    89 0000C2B5                                 ;bootpack启动
    90 0000C2B5 66 BB 00280000                      mov  ebx, botpak
    91 0000C2BB 67 66 8B 4B 10                      mov  ecx, [ebx+16]
    92 0000C2C0 66 83 C1 03                         add  ecx, 3
    93 0000C2C4 66 C1 E9 02                         shr  ecx, 2
    94 0000C2C8 74 10                               jz   skip            ;传输完成
    95 0000C2CA 67 66 8B 73 14                      mov  esi, [ebx+20]   ;源
    96 0000C2CF 66 01 DE                            add  esi, ebx
    97 0000C2D2 67 66 8B 7B 0C                      mov  edi, [ebx+12]   ;目标
    98 0000C2D7 E8 0014                             call memcpy
    99 0000C2DA                                 
   100 0000C2DA                                 skip:
   101 0000C2DA 67 66 8B 63 0C                      mov esp, [ebx+12]   ;堆栈初始化
   102 0000C2DF 66 EA 0000001B 0010                 jmp dword 2*8:0x0000001b
   103 0000C2E7                                 
   104 0000C2E7                                 waitkbdout:
   105 0000C2E7 E4 64                               in  al, 0x64
   106 0000C2E9 24 02                               and al, 0x02
   107 0000C2EB 75 FA                               jnz waitkbdout
   108 0000C2ED C3                                  ret
   109 0000C2EE                                 
   110 0000C2EE                                 memcpy:
   111 0000C2EE 67 66 8B 06                         mov eax, [esi]
   112 0000C2F2 66 83 C6 04                         add esi, 4
   113 0000C2F6 67 66 89 07                         mov [edi], eax
   114 0000C2FA 66 83 C7 04                         add edi, 4
   115 0000C2FE 66 83 E9 01                         sub ecx, 1
   116 0000C302 75 EA                               jnz memcpy
   117 0000C304 C3                                  ret
   118 0000C305                                 ;memcpy地址前缀大小
   119 0000C305 00 00 00 00 00 00 00 00 00 00       alignb 16
       0000C30F 00 
   120 0000C310                                 
   121 0000C310                                 gdt0:
   122 0000C310 00 00 00 00 00 00 00 00             resb 8      ;初始值
   123 0000C318 FFFF 0000 9200 00CF                 dw   0xffff, 0x0000, 0x9200, 0x00cf ;写32bit位寄存器
   124 0000C320 FFFF 0000 9A28 0047                 dw   0xffff, 0x0000, 0x9a28, 0x0047 ;可执行文件的32bit寄存器
   125 0000C328 0000                                dw   0
   126 0000C32A                                 gdtr0:
   127 0000C32A 0017                                dw     8*3-1
   128 0000C32C 0000C310                            dd     gdt0
   129 0000C330                                     alignb 16
   130 0000C330                                 bootpack: